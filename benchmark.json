{
    "benchmark": [
        {
            "scale": "joint",
            "tester": {
                "type": "generic",
                "environ": {
                    "name": "scenario1",
                    "btl_bw": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    "algorithm": ["reno", "cubic", "bbr", "prague"],
                    "repeat": [1, 2, 3, 4, 5]
                },
                "script": "/vagrant/net.py --out-dir $PWD --tcp-benchmark --algorithm $algorithm --bottleneck-bandwidth $btl_bw"
            }
        }
    ],
    "default": {
        "scale": "outer",
        "pipeline": {"name": "none"},
        "sut": {"type": "none"},
        "tester": {"type": "generic"},
        "traffic": {}
    },
    "visualize": [
        {
            "type": "simple",
            "title": "Goodput of classic vs. L4S-based CCs with varying bottleneck bandwidths [bps]",
            "x-axis": "btl_bw",
            "y-axis": ["goodput"],
            "error-bar": ["stddev_goodput"],
            "group-by": ["algorithm"],
            "aggregate": [
                {
                    "$match": {
                        "tester.environ.name": "scenario1"
                    }
                },
                {
                    "$group": {
                        "_id": {
                            "btl_bw": "$tester.environ.btl_bw", "algorithm": "$tester.environ.algorithm"
                        },

                        "null": 0,
                        "algorithm": {"$first": "$tester.environ.algorithm"},
                        "btl_bw": {"$first": "$tester.environ.btl_bw"},

                        "goodput": {
                            "$avg": {
                                "$getField": {
                                    "field": "bits_per_second",
                                    "input": {
                                        "$first":
                                        {
                                            "$getField": {
                                                "field": "streams",
                                                "input": {"$first": "$out.client.intervals"}
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        "stddev_goodput": {
                            "$stdDevPop": {
                                "$getField": {
                                    "field": "bits_per_second",
                                    "input": {
                                        "$first":
                                        {
                                            "$getField": {
                                                "field": "streams",
                                                "input": {"$first": "$out.client.intervals"}
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            ]
        },
        {
            "type": "simple",
            "title": "Latency of classic vs. L4S-based CCs with varying bottleneck bandwidths [ms]",
            "x-axis": "btl_bw",
            "y-axis": ["rtt"],
            "error-bar": ["stddev_rtt"],
            "group-by": ["algorithm"],
            "aggregate": [
                { "$match": {"tester.environ.name": "scenario1"} },
                {
                    "$addFields": {
                        "rtt": {
                            "$getField": {
                                "field": "rtt",
                                "input": {
                                    "$first": {
                                        "$getField": {
                                            "field": "streams",
                                            "input": {"$first": "$out.client.intervals"}
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                {
                    "$group": {
                        "_id": {
                            "btl_bw": "$tester.environ.btl_bw",
                            "algorithm": "$tester.environ.algorithm"
                        },
                        "null": 0,
                        "algorithm": {"$first": "$tester.environ.algorithm"},
                        "btl_bw": {"$first": "$tester.environ.btl_bw"},
                        "rtt": {"$avg": "$rtt"},
                        "stddev_rtt": {"$stdDevPop": "$rtt"}
                    }
                }
            ]
        },
        {
          "type": "simple",
          "title": "ECN-marking ratio of classic vs. L4S-based CCs with varying bottleneck bandwidths [count]",
          "x-axis": "btl_bw",
          "y-axis": ["ratio"],
          "error-bar": ["stddev_ratio"],
          "group-by": ["algorithm"],
          "aggregate": [
            { "$match": {"tester.environ.name": "scenario1"} },
            {
              "$addFields": {
                "eth2": {
                  "$first": {
                    "$filter": {
                      "input": "$out.router",
                      "as": "this",
                      "cond": {
                        "$and": [
                          {"$eq": ["$$this.kind", "dualpi2"]},
                          {"$eq": ["$$this.dev", "r0-eth2"]}
                        ]
                      }
                    }
                  }
                }
              }
            },
            {
              "$addFields": {
                "ratio": {
                  "$divide": [
                    "$eth2.ecn_mark",
                    "$eth2.packets"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": {
                  "btl_bw": "$tester.environ.btl_bw",
                  "algorithm": "$tester.environ.algorithm"
                },
                "null": 0,
                "algorithm": {"$first": "$tester.environ.algorithm"},
                "btl_bw": {"$first": "$tester.environ.btl_bw"},
                "ratio": {"$avg": "$ratio"},
                "stddev_ratio": {"$stdDevPop": "$ratio"}
              }
            }
          ]
        }
    ]
}
